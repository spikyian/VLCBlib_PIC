<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VLCB library: VLCB</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">VLCB library<span id="projectnumber">&#160;1</span>
   </div>
   <div id="projectbrief">VLCB C library for PIC</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">VLCB </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section copyright"><dt>Copyright</dt><dd>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License. </dd></dl>
<dl class="section author"><dt>Author</dt><dd>Ian Hogg </dd></dl>
<dl class="section date"><dt>Date</dt><dd>Dec 2022   </dd></dl>
<hr  />
<p> C library for VLCB. Written for XC8.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
The structure of the library</h1>
<table style="border-collapse: collapse;">
<tr>
<td colspan="2" style="border-top:2px solid; border-left:2px solid;border-right:2px solid;width:5em;background-color:lightblue;">App </td><td colspan="8">&#160;  </td></tr>
<tr>
<td style="border-left:2px solid;background-color:lightblue;">&#160; </td><td colspan="9" style="border:2px solid;background-color:lightgreen;text-align: center;">VLCB  </td></tr>
<tr>
<td style="border-left:2px solid;background-color:lightblue;width:5em;">&#160; </td><td style="border:1px solid;border-right:2px solid;background-color:lightblue;">APP callbacks </td><td style="width:2em;">&#160; </td><td colspan="4" style="border-left:2px solid;border-top:2px solid;border-bottom:2px solid;background-color:yellow;text-align: center;"><a class="el" href="struct_service.html">Service</a> interface </td><td style="border-right:2px solid;border-top:2px solid;border-bottom:2px solid;width:3em;background-color:yellow;">&#160; </td><td style="width:2em;">&#160; </td><td style="border:2px solid;background-color:bisque;"><a class="el" href="struct_transport.html">Transport</a> interface  </td></tr>
<tr>
<td style="border-left:2px solid;border-bottom:2px solid;background-color:lightblue;">&#160; </td><td style="border-right:2px solid;border-bottom:2px solid;background-color:lightblue;">&#160; </td><td>&#160; </td><td style="border:2px solid;background-color:mediumOrchid;"><a class="el" href="struct_service.html">Service</a> 1 </td><td>&#160; </td><td style="border:2px solid;background-color:hotPink;"><a class="el" href="struct_service.html">Service</a> 2 </td><td>&#160; </td><td colspan="3" style="border:2px solid;background-color:lightCoral;text-align:center;"><a class="el" href="struct_transport.html">Transport</a> <a class="el" href="struct_service.html">Service</a>  </td></tr>
<tr>
<td style="text-align:center;">&uarr;&uarr;&uarr;&uarr; </td><td style="text-align:center;">&darr;&darr;&darr;&darr; </td><td>&#160; </td><td>&#160; </td><td>&#160; </td><td>&#160; </td><td>&#160; </td><td colspan="3" style="text-align:center;">&uarr;&darr;  </td></tr>
<tr>
<td colspan="2" style="text-align:center;">Module I/O </td><td>&#160; </td><td>&#160; </td><td>&#160; </td><td>&#160; </td><td>&#160; </td><td colspan="3" style="text-align:center;">BUS  </td></tr>
</table>
<p>All services must support the <a class="el" href="struct_service.html">Service</a> interface. <a class="el" href="struct_transport.html">Transport</a> services must also support the <a class="el" href="struct_transport.html">Transport</a> interface. The APP makes use of VLCB functionality and also provides functionality to VLCB.</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Application</h1>
<p>The application provides the module specific functionality. VLCB provides much of the standard functionality of VLCB modules. Different VLCB capabilities are enabled through the use of VLCB services. For example CAN bus support can be enabled by including the CAN service.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Application functionality</h2>
<p>An VLCB module using this library needs to consider the following application responsibilities:</p>
<h3><a class="anchor" id="autotoc_md27"></a>
Inputs</h3>
<ul>
<li>Monitoring input pins,</li>
<li>Perform behaviour based upon module NV settings,</li>
<li>Save input state according to type of input in RAM</li>
<li>Send events to the transport layer according to behaviour requirements</li>
</ul>
<h3><a class="anchor" id="autotoc_md28"></a>
Outputs</h3>
<ul>
<li>Receive messages from the transport layer or receive actions from the action queue</li>
<li>Use the NV settings to determine the behaviour</li>
<li>Save state into non volatile memory e.g. EEPROM</li>
<li>Make changes to the output pin state</li>
</ul>
<h3><a class="anchor" id="autotoc_md29"></a>
On power on</h3>
<ul>
<li>Restore output state using the information stored in non volatile memory</li>
<li>Initialise input state based upon current input pin state</li>
</ul>
<h3><a class="anchor" id="autotoc_md30"></a>
Regular poll</h3>
<ul>
<li>Update and perform time based behaviour</li>
</ul>
<h2><a class="anchor" id="autotoc_md31"></a>
Module design</h2>
<p>The designer of a module needs to:</p><ol type="1">
<li>Determine which services the module will use.</li>
<li>Write a modules.h which is used by the VLCBlib to control its operation.</li>
<li>If the module will use NVs then:<ul>
<li>Define the NV usage and allocation,</li>
<li>Define the memory allocation (type and address) for the NVs,</li>
<li>Define the default value (factory reset settings) of the NVs,</li>
<li>Determine whether any validation of NV settings is required.</li>
</ul>
</li>
<li>If the module has a CAN interface:<ul>
<li>Decide where in NVM the CANID is to be stored,</li>
<li>Decide how much memory can be used for transmit and receive buffers.</li>
</ul>
</li>
<li>If the module is to support event teaching:<ul>
<li>Decide the number of events and number of EVs per event,</li>
<li>Define the event EV usage and allocation,</li>
<li>Define the memory allocation (type and address) for the EVs,</li>
</ul>
</li>
<li>If the module also supports produced events then:<ul>
<li>If the concept of Happenings is to be used then defined the size of the Happening identifier,</li>
<li>Provide a function to provide the current event state given a Happening</li>
</ul>
</li>
<li>If the module also supports consumed events then:<ul>
<li>If Actions concept is to be used then the size of the Action queue should be defined.</li>
</ul>
</li>
<li>All modules also need:<ul>
<li>The address and type of NVM where the module's node number is to be stored,</li>
<li>The address and type of NVM where the mode is to be stored,</li>
<li>Define the module type name, module ID and version,</li>
<li>The number of LEDs used to display module state,</li>
<li>A macro to obtain the push button state,</li>
<li>A macro to set up the ports for the LEDs and push button.</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md32"></a>
Other information</h2>
<ul>
<li>The module mode is available using the uint8_t mode global variable.</li>
<li>The module submodes are available using the uint8_t mode_flags global variable.</li>
<li>The module's node number is available as <a class="el" href="union_word.html">Word</a> nn global variable.</li>
<li>A module should include either statusLeds1.c or <a class="el" href="status_leds2_8c.html" title="LED handling for 2 LEDs.">statusLeds2.c</a> depending whether it has one or two LEDs.</li>
<li>A module may define a function to process VLCB messages before being handled by the library.</li>
<li>A module may also define a function to process VLCB messages if not handled by the library.</li>
</ul>
<h2><a class="anchor" id="autotoc_md33"></a>
Application source</h2>
<p>The application source file must provide:</p><ol type="1">
<li>An array of <a class="el" href="struct_service.html">Service</a> definitions const <a class="el" href="struct_service.html">Service</a> * const services[] which must be initialised with pointers to each service definition for the services required by the application. For example <div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code hl_struct" href="struct_service.html">Service</a> * <span class="keyword">const</span> <a class="code hl_variable" href="vlcb_8h.html#a8d4c9b659f98c72e727bca232c257bfe">services</a>[] = {</div>
<div class="line">    &amp;<a class="code hl_variable" href="can_8h.html#a2710ddf8079472011d4b89bcdacd52a4">canService</a>,</div>
<div class="line">    &amp;<a class="code hl_variable" href="mns_8c.html#a05160624e3e355535f7bc7dae4fad5a4">mnsService</a>,</div>
<div class="line">    &amp;<a class="code hl_variable" href="nv_8c.html#a54cb92ae67b344b1663b74af93adf6f0">nvService</a>,</div>
<div class="line">    &amp;<a class="code hl_variable" href="boot_8c.html#a6a89fc238ad82ace7c465216a3e5575d">bootService</a>,</div>
<div class="line">    &amp;<a class="code hl_variable" href="event__teach_8h.html#a25dbd341349525d3b0917340575378b7">eventTeachService</a>,</div>
<div class="line">    &amp;<a class="code hl_variable" href="event__consumer__action_8c.html#a00bee6233d82533e4e0bc10911787455">eventConsumerService</a>,</div>
<div class="line">    &amp;<a class="code hl_variable" href="event__producer_8h.html#a6d039ebee6188cb69fc81dedf126c334">eventProducerService</a>,</div>
<div class="line">    &amp;<a class="code hl_variable" href="event__acknowledge_8c.html#a8dace442c6fec52297eed2d68ed100d6">eventAckService</a></div>
<div class="line">};</div>
<div class="ttc" id="aboot_8c_html_a6a89fc238ad82ace7c465216a3e5575d"><div class="ttname"><a href="boot_8c.html#a6a89fc238ad82ace7c465216a3e5575d">bootService</a></div><div class="ttdeci">const Service bootService</div><div class="ttdef"><b>Definition</b> boot.c:74</div></div>
<div class="ttc" id="acan_8h_html_a2710ddf8079472011d4b89bcdacd52a4"><div class="ttname"><a href="can_8h.html#a2710ddf8079472011d4b89bcdacd52a4">canService</a></div><div class="ttdeci">const Service canService</div><div class="ttdef"><b>Definition</b> can18_can_2.c:119</div></div>
<div class="ttc" id="aevent__acknowledge_8c_html_a8dace442c6fec52297eed2d68ed100d6"><div class="ttname"><a href="event__acknowledge_8c.html#a8dace442c6fec52297eed2d68ed100d6">eventAckService</a></div><div class="ttdeci">const Service eventAckService</div><div class="ttdef"><b>Definition</b> event_acknowledge.c:71</div></div>
<div class="ttc" id="aevent__consumer__action_8c_html_a00bee6233d82533e4e0bc10911787455"><div class="ttname"><a href="event__consumer__action_8c.html#a00bee6233d82533e4e0bc10911787455">eventConsumerService</a></div><div class="ttdeci">const Service eventConsumerService</div><div class="ttdef"><b>Definition</b> event_consumer_action.c:69</div></div>
<div class="ttc" id="aevent__producer_8h_html_a6d039ebee6188cb69fc81dedf126c334"><div class="ttname"><a href="event__producer_8h.html#a6d039ebee6188cb69fc81dedf126c334">eventProducerService</a></div><div class="ttdeci">const Service eventProducerService</div><div class="ttdef"><b>Definition</b> event_producer_happening.c:84</div></div>
<div class="ttc" id="aevent__teach_8h_html_a25dbd341349525d3b0917340575378b7"><div class="ttname"><a href="event__teach_8h.html#a25dbd341349525d3b0917340575378b7">eventTeachService</a></div><div class="ttdeci">const Service eventTeachService</div><div class="ttdef"><b>Definition</b> event_teach_large.c:315</div></div>
<div class="ttc" id="amns_8c_html_a05160624e3e355535f7bc7dae4fad5a4"><div class="ttname"><a href="mns_8c.html#a05160624e3e355535f7bc7dae4fad5a4">mnsService</a></div><div class="ttdeci">const Service mnsService</div><div class="ttdef"><b>Definition</b> mns.c:151</div></div>
<div class="ttc" id="anv_8c_html_a54cb92ae67b344b1663b74af93adf6f0"><div class="ttname"><a href="nv_8c.html#a54cb92ae67b344b1663b74af93adf6f0">nvService</a></div><div class="ttdeci">const Service nvService</div><div class="ttdef"><b>Definition</b> nv.c:82</div></div>
<div class="ttc" id="astruct_service_html"><div class="ttname"><a href="struct_service.html">Service</a></div><div class="ttdef"><b>Definition</b> vlcb.h:307</div></div>
<div class="ttc" id="avlcb_8h_html_a8d4c9b659f98c72e727bca232c257bfe"><div class="ttname"><a href="vlcb_8h.html#a8d4c9b659f98c72e727bca232c257bfe">services</a></div><div class="ttdeci">const Service *const services[]</div></div>
</div><!-- fragment --></li>
<li>A void init(void) function which sets the transport status pointer e.g. transport = &amp;canTransport; This function must also do any additional, application specific initialisation.</li>
<li>A void <a class="el" href="vlcb_8c.html#a0b33edabd7f1c4e4a0bf32c67269be2f">loop(void)</a> function to perform any regular processing required by the application.</li>
<li>Callback functions required by the VLCB library depending upon the services used:<ul>
<li>uint8_t <a class="el" href="nv_8c.html#abe82e0f5aaf414e39df9aa403c794a01">APP_nvDefault(uint8_t index)</a> function to provide a default value for an NV.</li>
<li>void <a class="el" href="nv_8c.html#a763f8f826b59a23e6a2fd211a05765b7">APP_nvValueChanged(uint8_t index, uint8_t value, uint8_t oldValue)</a> function called when an NV has its value changed.</li>
<li>NvValidation <a class="el" href="nv_8h.html#ac06d3e7bb45cc0d2eb4d08558047f1ca">APP_nvValidate(uint8_t index, uint8_t value)</a> function to allow the application to validate a new NV value.</li>
<li>uint8_t APP_addEvent(uint16_t nodeNumber, uint16_t eventNumber, uint8_t evNum, uint8_t evVal)* function to be provided by the application and is called when an event is added. Typically this will just call the VLCB library addEvent(uint16_t nodeNumber, 
   uint16_t eventNumber, uint8_t evNum, uint8_t evVal) function.</li>
<li>ValidTime <a class="el" href="nvm_8h.html#ae34d4d879380e8085b5e975b6186f58e">APP_isSuitableTimeToWriteFlash(void)</a> called by the library to check whether the application is currently performing any time critical operations or whether processing can be temporarily suspended to write to Flash memory.</li>
<li>Processed <a class="el" href="vlcb_8c.html#a7b80b521ea40399b62af546746ecd769">APP_preProcessMessage(Message * m)</a> called before a received message is to be processed by the VLCB library. This allows and processing provided by the library to be replaced by application specific handling.</li>
<li>Processed <a class="el" href="vlcb_8c.html#a664c7f5e506993130616dcf9604601d9">APP_postProcessMessage(Message * m)</a> called after a received message to checked by the VLCB library if the library does not handle the message.</li>
<li>void <a class="el" href="vlcb_8c.html#aaefa2e9d7f924327aa066ed75aca0319">APP_factoryReset(void)</a> called when the module is performing a factory reset and allows the application to set up any non volatile memory required.</li>
<li>void <a class="el" href="vlcb_8c.html#a0644eaabac4710a72d208c3aab733d2e">APP_testMode(void)</a> called by the library if the button was held down at power up to allow the application to perform special test facilities.</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md34"></a>
Module.h</h2>
<p>The developer of an application must provide a module.h which has module/application specific definitions which influence the behaviour of VLCB.</p>
<p>Each service documents any requirements it may add for the module.h file. </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
